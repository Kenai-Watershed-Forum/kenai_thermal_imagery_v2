---
title: "Thermal Imagery Data"
editor: visual
---

```{r, echo = F}

knitr::opts_chunk$set(echo = FALSE, warning = F, message = F)
knitr::opts_knit$set(progress=FALSE, verbose=FALSE)
```

```{r}
# clear environment
rm(list=ls())

# load packages
library(bookdown)
library(rmarkdown)
library(tidyverse)
library(googlesheets4)
library(DT)
library(plotly)
library(kableExtra)
library(hms)
```

```{r TIR-fig1, echo = F, fig.cap = "Example of airborne thermal infrared imagery showing temperature contrast in a stream. A cold water inflow (purple and blue colors) enters the main channel (yellow color). Figure from NV5 Geospatial consultants report.", out.height=300, out.height=300}

knitr::include_graphics('images/example_TIR_figure.jpg')

```

## Introduction

To acquire and prepare thermal aerial infrared imagery, we worked with [NV5 Geospatial](https://www.nv5.com/geospatial/) (formerly Watershed Sciences, Inc), an experienced contractor who has led prior efforts in the region to gather thermal aerial infrared data for aquatic habitat research [@watershedsciences2010]. On July 5, 2020, NV5 collected thermal infrared imagery from a helicopter-mounted camera for the four steams on the Kenai Peninsula lowlands that were the focus of this study (Beaver Creek, Funny River, Moose River, and Crooked Creek). All streams were flown during the afternoon hours in order to maximize the thermal contrast between the river's water and the banks.

The surveys extend for a total length of 59.1 km of the streams. Flight transects proceeded from the mouth of each stream in an upstream direction. The data were collected to aid the team in identifying the spatial variability in surface temperatures as well as thermal influence of point sources, tributaries, and surface springs.

Specific deliverables generated by NV5 Geospatial from the thermal imagery data include:

-   Rasters (map image files; .tif and .jpg formats)

-   Shapefiles (longitudinal temperature profiles, stream centerlines, others; .shp format)

-   Other supplemental items (coordinates of significant thermal features, maps and figures, and others)

The full technical report from NV5 Geospatial describing detailed methods and interpretation can be downloaded at the following link:

```{r echo = F}
library(xfun)
xfun::embed_file("documents/TIR_Technical_Data_Report_Kenai_Rivers_20210107.pdf", text = "Download 'Kenai Rivers - Thermal Infrared Airborne Imagery Technical Data Report'")

```

<br> The image raster files are of a large size (\~3 GB) and may be acquired by contacting staff at Cook Inletkeeper (sue\@inletkeeper.org), Kenai Watershed Forum (hydrology\@kenaiwatershed.org), or Kachemak Heritage Land Trust (info\@kachemaklandtrust.org).

<br>

## Parcel data summary

We generated a table in GIS (ArcMap Pro 10.8.1) of parcels in the Kenai Peninsula Borough that intersect with cold-water inputs (e.g. seeps, springs) within the surveyed areas of Beaver Creek, Crooked Creek, Moose River, and Funny River.

```{r, include = F}

# Create table with information relevant for ground-truthing fieldwork

# read in a reduced set of columns
tbl1 <- read.csv("input/parcels/csv/parcel_and_significant_feature_intersect_1.csv") %>%
  select(Stream_Name,
         feature_type,
         feature_type,
         Latitude, Longitude,
         Site_Name,
         Rvr_mile,
         L_R_Bank,
         M_Off_str,   
         USAGE,
         SITUS_ADDR,
         ACREAGE,
         OWNER,
         OWNTYPE,
         PARCEL_ID,
         LANDVAL) 

# rename columns
names <- c("Stream_Name",
            "Feature_Type",
           "Latitude","Longitude",
           "Site_Name",
           "Rvr_Mile",
           "L_R_Bank",
           "M_off_str",
           "Usage",
           "Address",
           "Acres",
           "Owner",
           "Owner_Type",
           "Parcel ID",
           "Value")

colnames(tbl1) <- names

# prep order
tbl1 <- tbl1 %>%
  arrange(Stream_Name)


```

@fig-parcel-plot summarizes the ownership type of these parcels by general category of owner type.

```{r, include = F}
t <- tbl1 %>%
  count(Stream_Name,Owner_Type) 
```

```{r parcel-plot, echo = FALSE}
#| label: fig-parcel-plot
#| fig-cap: "Parcel ownership by land owner type for lands containing cold water refugia in our study streams"

ggplotly(
  p <- tbl1 %>%
    ggplot(aes(Stream_Name, fill = Owner_Type)) +
    geom_bar(position = position_dodge2(preserve = "single")) +
    xlab("") +
    ylab("Parcel Count") +
    ggtitle("Parcels with Cold Water Refugia\nby Owner Type")
  )
```

<br>

## Ground truth data

On July 7-8, 2021 we visited a subset of sites identified by the NV5 Geospatial Consultants report as cold water features. We visited 12 of 63 total sites. We recorded surface water temperatures of the identified features as well as the adjacent main stem using a using a Hach Sension 5 portable meter. The average time difference between main stem temperature observation and off-channel observation was 13.9 minutes. We created a graphic sketch of the layout of each feature, and recorded site photos.

Field forms, including site sketches, can be accessed at the following link:

```{r echo = F}
library(xfun)
xfun::embed_file("documents/Kenai TIR ground truthing datasheets.pdf", text = "Download Ground Truthing Field Forms from July 2021")

```

<br>

@fig-gtobs through @fig-gt-tir-obs-funny visualize water temperature data sourced from the significant features in aerial imagery on July 20, 2020 along with ground-truthed measurements from July 7-8, 2021. In general we observed symmetry in the pattern of temperature contrast for both our ground-truthed data as well as temperatures observed from the thermal aerial infrared dataset.

<br>

```{r, echo = F}

## read in feature data

# read in a reduced set of columns
tbl1 <- read.csv("input/parcels/csv/parcel_and_significant_feature_intersect_1.csv") %>%
  select(Stream_Name,
         feature_type,
         Site_Name,
         Latitude, 
         Longitude,
         #Mean,
         #Median,
         #Min,
         Std_Dev
        ) 

# rename columns
names <- c("Stream_Name",
           "Feature_Type",
            "Site_Name",
          "Latitude",
           "Longitude",
           "TIR_feature_temp_stdev"
           )

colnames(tbl1) <- names


## read in ground truth data

### specify temperature metrics and observations
metrics <- c(
  "TIR_mainstem_mean_temp_C",
  "TIR_mainstem_median_temp_C",
  "TIR_mainstem_min_temp_C",
  "TIR_mainstem_max_temp_C",
     
  # thermal imagery feature values
  "TIR_feature_mean_temp_C",
  "TIR_feature_median_temp_C",
  "TIR_feature_min_temp_C",
  "TIR_feature_max_temp_C",
     
  # ground truth temperature values
  "GT_feature_temp_C",
  "GT_mainstem_temp_C")


# read in
gt <- read_sheet("https://docs.google.com/spreadsheets/d/1NGnxuaW70K7ZFb-m4krSRx3WcKxHqhBRN-Muowr5HFc/edit#gid=1240916748", sheet = "Ground_Truthing") %>%
  select(Stream_Name,
         Site_Name,
         Date,
         all_of(metrics),
     #    Latitude,
     #    Longitude,
     
     # thermal imagery mainstem temperature values
     #TIR_mainstem_mean_temp_C,
     #TIR_mainstem_median_temp_C,
     #TIR_mainstem_min_temp_C,
     #TIR_mainstem_max_temp_C,
     
     # thermal imagery feature values
    # TIR_feature_mean_temp_C,
    # TIR_feature_median_temp_C,
    # TIR_feature_min_temp_C,
    # TIR_feature_max_temp_C,
     
     # ground truth temperature values
     #    GT_feature_temp_C,
     #    GT_mainstem_temp_C,
         GT_mainstem_cond,
         GT_feature_time,
         GT_mainstem_time) %>%
  rename("GT_Date" = "Date") %>%
  transform(GT_feature_time = as_hms(GT_feature_time),
            GT_mainstem_time = as_hms(GT_mainstem_time))


## join ground truthing data with TIR significant feature data
gt <- inner_join(tbl1,gt, by = c("Site_Name","Stream_Name")) 
```

```{r, gt-data-prep, echo = FALSE}
#
gt_long <- gt %>%
  #select(-Stream_Name,-Feature_Type,-Latitude,-Longitude) %>%
  pivot_longer(cols = c(all_of(metrics),
               "TIR_feature_temp_stdev"),
               
               #c("TIR_feature_temp_mean",   
                #        "TIR_feature_temp_median", 
                #        "TIR_feature_temp_min",
                 #       "TIR_feature_temp_stdev",
                 #       "GT_feature_temp_C",
                  #      "GT_mainstem_temp_C"
                   #   ),
               names_to = "stat",
               values_to = "val",
               values_drop_na = TRUE) %>%
  separate(stat,sep = "_",into = c("obs_type","hydro_type","c","stat_type"), remove = F) %>%
  mutate(stat_type = str_replace(stat_type,"C","observed")) %>%
  mutate(hydro_obs_type = paste0(obs_type,"_",hydro_type)) %>%
  rename("stat_name" = "c") %>%
  filter(stat_type != "stdev")


# plot ground truth observations, feature vs main channel
```

```{r, echo = F}
# how far apart in time were mainstem vs off channel ground truth observations?
time_diff <- gt_long %>%
  filter(obs_type == "GT") %>%
  mutate(time_interval = abs(difftime(GT_feature_time,GT_mainstem_time,units = "mins"))) %>%
  filter(!is.na(time_interval)) %>%
  summarise(avg_diff = mean(time_interval))

```

```{r fig-gtobs, echo = F, fig.cap = "Cold Feature vs. Mainstem, ground truth observations water temperature data."}

#| label: fig-gtobs
#| fig-cap: "Cold Feature vs. Mainstem, ground truth observations water temperature data"

# ground truth data only

# plot 1, facet wrap
gt_long %>%
  filter(obs_type == "GT") %>%
  ggplot() +
   facet_wrap(Stream_Name ~ Site_Name) +
  geom_point(aes(hydro_obs_type, val, shape = stat_type)) +
    theme(axis.text.x = element_text(angle = 90,size = 12)) +
    xlab("") +
    ylab("Water Temperature (C)") +
  theme_bw() +
  theme(panel.spacing.y = unit(2, "lines"),
        legend.position = "none") +
  scale_x_discrete(breaks = c("GT_feature","GT_mainstem"),
                   labels = c("Cold Feature","Mainstem")) +
  ggtitle("Cold Features vs Mainstem Water Temperatures\n Ground Truth Observations")
```

<br>

```{r fig-tir-obs, echo = F, fig.cap = "Cold Feature vs. Mainstem, thermal infrared water temperature data."}

#| label: fig-tir-obs
#| fig-cap: "Cold Feature vs. Mainstem, thermal infrared water temperature data."


### TIR data 
gt_long %>%
  filter(obs_type == "TIR") %>%
  ggplot() +
   facet_wrap(Stream_Name ~ Site_Name) +
  geom_jitter(aes(hydro_obs_type, val, shape = stat_name), width = 0.09) +
    theme(axis.text.x = element_text(angle = 90,size = 12)) +
    xlab("") +
    ylab("Water Temperature (C)") +
  theme_bw() +
  theme(panel.spacing.y = unit(2, "lines")) +
  scale_x_discrete(breaks = c("TIR_feature","TIR_mainstem"),
                   labels = c("Cold Feature","Mainstem")) +
  ggtitle("Cold Features vs Mainstem Water Temperatures\n Thermal Infrared Observations")
```

<br>

```{r fig-gt-tir-obs-beaver, echo = F, fig.cap = "Beaver Creek water temperatures, ground truth and thermal infrared imagery observations."}

#| label: fig-gt-tir-obs-beaver
#| fig-cap: "Beaver Creek water temperatures, ground truth and thermal infrared imagery observations."

# plot ground truth and TIR observations, feature vs main channel, for each watershed

# beaver
gt_long %>%
  filter(Stream_Name == "Beaver Creek")  %>%
  mutate(obs_type = case_when(
    obs_type == "GT" ~ "Ground Truth Observations",
    obs_type == "TIR" ~ "Thermal Infrared Data"
  )) %>%
  ggplot() + 
  facet_grid(Site_Name ~ obs_type, scales = "free_x") +
  geom_jitter(aes(hydro_obs_type, val, shape = stat_name), size = 2, width = 0.07) +
  xlab("") +
  ylab("Water Temperature (C)") +
  scale_x_discrete(breaks = c("GT_feature","GT_mainstem","TIR_feature","TIR_mainstem"),
                   labels = c("Cold Feature","Mainstem","Cold Feature","Mainstem")) +
  ggtitle("Beaver Creek Water Temperatures") +
  scale_shape_discrete(name="Water\nTemperature\nValue") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0,size = 12),
        strip.text.y = element_text(angle = 0))
  
```

<br>

```{r fig-gt-tir-obs-crooked, echo = F, fig.cap = "Crooked Creek water temperatures, ground truth and thermal infrared imagery observations."}

#| label: fig-gt-tir-obs-crooked
#| fig-cap: Crooked Creek water temperatures, ground truth and thermal infrared imagery observations.

# plot ground truth and TIR observations, feature vs main channel, for each watershed

# crooked
gt_long %>%
  filter(Stream_Name == "Crooked Creek")  %>%
  mutate(obs_type = case_when(
    obs_type == "GT" ~ "Ground Truth Observations",
    obs_type == "TIR" ~ "Thermal Infrared Data"
  )) %>%
  ggplot() + 
  facet_grid(Site_Name ~ obs_type, scales = "free_x") +
  geom_jitter(aes(hydro_obs_type, val, shape = stat_name), size = 2, width = 0.07) +
  xlab("") +
  ylab("Water Temperature (C)") +
  scale_x_discrete(breaks = c("GT_feature","GT_mainstem","TIR_feature","TIR_mainstem"),
                   labels = c("Cold Feature","Mainstem","Cold Feature","Mainstem")) +
  ggtitle("Crooked Creek Water Temperatures") +
  scale_shape_discrete(name="Water\nTemperature\nValue") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0,size = 12),
        strip.text.y = element_text(angle = 0))
```

<br>

```{r fig-gt-tir-obs-funny, echo = F, fig.cap = "Funny River water temperatures, ground truth and thermal infrared imagery observations."}

#| label: fig-gt-tir-obs-funny
#| fig-cap: Funny River water temperatures, ground truth and thermal infrared imagery observations.

# plot ground truth and TIR observations, feature vs main channel, for each watershed

# funny
gt_long %>%
  filter(Stream_Name == "Funny River")  %>%
  mutate(obs_type = case_when(
    obs_type == "GT" ~ "Ground Truth Observations",
    obs_type == "TIR" ~ "Thermal Infrared Data"
  )) %>%
  ggplot() + 
  facet_grid(Site_Name ~ obs_type, scales = "free_x") +
  geom_jitter(aes(hydro_obs_type, val, shape = stat_name), size = 2, width = 0.07) +
  xlab("") +
  ylab("Water Temperature (C)") +
  scale_x_discrete(breaks = c("GT_feature","GT_mainstem","TIR_feature","TIR_mainstem"),
                   labels = c("Cold Feature","Mainstem","Cold Feature","Mainstem")) +
  ggtitle("Funny River Water Temperatures") +
  scale_shape_discrete(name="Water\nTemperature\nValue") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0,size = 12),
        strip.text.y = element_text(angle = 0))
```

<br>

## Collaborative Assessment

Researchers with participating organizations assessed conservation strategies within each study watershed, and recorded their notes on a shared platform. These collective notes are being used internally to inform strategy for outreach approaches with local property owners.

Data sources used to assess parcel-specific conservation strategies include:

-   Custom maps for each significant thermal feature, including information about the parcel or parcels that it occupies

-   Information about individual thermal features from the [NV5 Geospatial Consultants Report](https://github.com/Kenai-Watershed-Forum/kenai_thermal_imagery/blob/master/documents/TIR_Technical_Data_Report_Kenai_Rivers_20210107.pdf), including mean value and contrast with the main stem

-   The [ArcGIS Online project map](https://arcg.is/fzn14)

**Project collaborators may access the Thermal Imagery Database Google Sheet using the link below:**

**Link: [Thermal Imagery Collaborative Assessment](https://docs.google.com/document/d/1TZcTMBOL6WDCyvOODZlGeuCd-1sPWzYsurWtx7MJoUE/edit)**

An example map is shown in \@fig-example-map.

```{r fig-example-map, echo = F, out.height=325, out.width=375, fig.cap = "Example of airborne thermal infrared imagery map with parcel overlay."}

#| label: fig-example-map
#| fig-cap: "Example of airborne thermal infrared imagery map with parcel overlay"

knitr::include_graphics('images/Beaver_Crk4.png')

```
